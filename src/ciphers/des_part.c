/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   des_part.c                                         :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: hmartzolf <hmartzol@student.42.fr>         +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2023/01/01 00:00:00 by hmartzolf         #+#    #+#             */
/*   Updated: 2023/01/01 00:00:00 by hmartzolf        ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

# include <stddef.h>
# include <stdint.h>

/**
* do initial (inverse) permutation of v
* @param v input/output of des
* @param inverse toggle between input (false) and output (true)
* @return permuted value
*/
uint64_t	des_initial_permutation(uint64_t v, int inverse)
{
	const size_t	shifts_1[64] = {58, 50, 42, 34, 26, 18, 10, 2, 60, 52,
		44, 36, 28, 20, 12, 4, 62, 54, 46, 38, 30, 22, 14, 6, 64, 56, 48, 40,
		32, 24, 16, 8, 57, 49, 41, 33, 25, 17, 9, 1, 59, 51, 43, 35, 27, 19,
		11, 3, 61, 53, 45, 37, 29, 21, 13, 5, 63, 55, 47, 39, 31, 23, 15, 7};
	const size_t	shifts_2[64] = {40, 8, 48, 16, 56, 24, 64, 32, 39, 7,
		47, 15, 55, 23, 63, 31, 38, 6, 46, 14, 54, 22, 62, 30, 37, 5, 45, 13,
		53, 21, 61, 29, 36, 4, 44, 12, 52, 20, 60, 28, 35, 3, 43, 11, 51, 19,
		59, 27, 34, 2, 42, 10, 50, 18, 58, 26, 33, 1, 41, 9, 49, 17, 57, 25};
	size_t			i;
	uint64_t		out;

	out = 0;
	i = -1;
	if (inverse)
		while (++i < 64)
			out = (out << 1) | ((v >> (64 - shifts_2[i])) & 1);
	else
		while (++i < 64)
			out = (out << 1) | ((v >> (64 - shifts_1[i])) & 1);
	return (out);
}

void	des_initial_key_permutation(uint64_t key, uint32_t ks[2])
{
	const size_t	shifts[56] = {57, 49, 41, 33, 25, 17, 9, 1, 58, 50,
		42, 34, 26, 18, 10, 2, 59, 51, 43, 35, 27, 19, 11, 3, 60, 52, 44, 36,
		63, 55, 47, 39, 31, 23, 15, 7, 62, 54, 46, 38, 30, 22, 14, 6, 61, 53,
		45, 37, 29, 21, 13, 5, 28, 20, 12, 4};
	size_t			i;
	uint64_t		acc;

	acc = 0;
	i = -1;
	while (++i < 56)
		acc = (acc << 1) | ((key >> (64 - shifts[i])) & 1);
	ks[0] = (uint32_t)((acc >> 28) & 0xFFFFFFF);
	ks[1] = (uint32_t)(acc & 0xFFFFFFF);
}

void	des_initialize_sub_keys(uint32_t ks[2], uint64_t sub_keys[16])
{
	const size_t	sc[16] = {1, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 1};
	const size_t	shifts[48] = {14, 17, 11, 24, 1, 5, 3, 28, 15, 6, 21, 10,
		23, 19, 12, 4, 26, 8, 16, 7, 27, 20, 13, 2, 41, 52, 31, 37, 47, 55, 30,
		40, 51, 45, 33, 48, 44, 49, 39, 56, 34, 53, 46, 42, 50, 36, 29, 32};
	size_t			i;
	size_t			j;
	uint64_t		acc;

	i = -1;
	while (++i < 16)
	{
		j = -1;
		while (++j < sc[i])
		{
			ks[0] = ((ks[0] << 1) & 0xFFFFFFE) | ((ks[0] >> 27) & 1);
			ks[1] = ((ks[1] << 1) & 0xFFFFFFE) | ((ks[1] >> 27) & 1);
		}
		acc = (((uint64_t)ks[0]) << 28) | (uint64_t)ks[1];
		sub_keys[i] = 0;
		j = -1;
		while (++j < 48)
			sub_keys[i] = (sub_keys[i] << 1) | ((acc >> (56 - shifts[j])) & 1);
	}
}

/**
* generated via scripting to reduce the boxes size. each box[s] is the binary
* concatenation of sbox[o][s] where
* box[s] == sbox[0][s] | (sbox[1][s] << 8) |  ... | (sbox[7][s] << 56);
*/

uint32_t	des_box(size_t box_index, uint8_t row, uint8_t column)
{
	const uint64_t	box[64] = {937887825247473422l, 147212564089012484l,
		577034714788464653l, 292187522846297601l, 436577614548043266l,
		1080866152642710287l, 794891978697278219l, 75725590766093320l,
		721420399685994755l, 651910361222285066l, 218709368458969606l,
		1010781103923334412l, 361710794255830021l, 2822446550089737l,
		866385536070321408l, 504696766777002503l, 75727824199942912l,
		1080880450622655759l, 939849354057876487l, 578433327787738884l,
		721709554148249358l, 218719281360404994l, 504694584681826317l,
		291050627822915073l, 868638396740930570l, 361133494749364230l,
		433767297220673804l, 796026670452443659l, 562962855888393l,
		1013040574632757509l, 650773479285525251l, 145812859950007560l,
		504694546195349508l, 793774836177833473l, 291343098016171790l,
		75722313538538248l, 651898288236661261l, 865544405498397702l,
		1010789865689910530l, 148059170862530827l, 2822511025390863l,
		436567727549777932l, 722269239876127753l, 939011539133531655l,
		1080865035934566659l, 217594463567610634l, 362833339743076869l,
		577030359523725056l, 145808483277671695l, 75157151928682508l,
		1012467741791947272l, 506668182384148738l, 288521751196205828l,
		721707397991173897l, 579292003553510401l, 938730098415567367l,
		1083409305908284165l, 866113960994080267l, 648519445937784579l,
		4229860071509006l, 220120072009220106l, 360850937440699648l,
		433198806759247366l, 796025540909467917l};

	return ((uint32_t)((box[16 * row + column] >> (8 * box_index)) & 0xF));
}